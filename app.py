from flask import Flask, request, jsonify, render_template
from flask_cors import CORS
import os
from langchain_community.chat_models import ChatOpenAI
from langchain_community.embeddings.huggingface import HuggingFaceEmbeddings
from langchain_community.vectorstores import FAISS
from langchain.text_splitter import CharacterTextSplitter
from langchain.memory import ConversationBufferMemory
from langchain.chains import ConversationalRetrievalChain


app = Flask(__name__)
CORS(app)

OPENAI_API_KEY = os.environ.get('OPENAI_API_KEY')

def get_text_chunks(text):
    text_splitter = CharacterTextSplitter(
        separator="\n",
        chunk_size=900,
        chunk_overlap=100,
        length_function=len
    )
    return text_splitter.split_text(text)

def get_vectorstore(text_chunks):
    embeddings = HuggingFaceEmbeddings()
    return FAISS.from_texts(text_chunks, embeddings)

def construct_conversation_chain(vectorstore):
    llm = ChatOpenAI(openai_api_key=OPENAI_API_KEY, model_name='gpt-3.5-turbo', temperature=0)
    memory = ConversationBufferMemory(memory_key='chat_history', return_messages=True)
    return ConversationalRetrievalChain.from_llm(
        llm=llm,
        retriever=vectorstore.as_retriever(),
        memory=memory
    )

def process_text_and_question(user_question):
    document_text="SIMPLE, COMPLIANT HIRING WITH HORIZONS PEO Hire in China A China Professional Employer Employer Organization (PEO) is an HR provider that hires and pays your team in China, on your behalf. A China PEO solution is commonly used by international companies expanding into China, or global firms interested in hiring specialist talent there. Horizons is a leading China PEO, hiring and onboarding your China-based team, processing payroll, and ensuring full compliance with local labor and tax laws. A China PEO, also known as a China Employer of Record (EOR), also absorbs all local employer liabilities. Partnering with our China PEO is the quickest and most cost-effective way to enter the Chinese market. Facts & Stats PEO Platform Hire in China, and pay employees through our platform or app. PEO Cost Our China PEO solution is the most affordable on the market. Time-to-hire Fast China onboarding, hire in as little as 12 hours. Contracts We draft compliant China labor contracts. Local benefits We manage all China “Five Insurances” mandatory benefits. 180+ Countries It doesn’t stop with China — we hire employees globally. HIRE EMPLOYEES IN CHINA What Is a China PEO? A China PEO is an independent HR firm that hires and pays your team in China, in full compliance with local laws. By engaging a China PEO, you no longer need to set up a China entity or subsidiary (such as a Wholly Foreign Owned Enterprise or WFOE) in order to have a China-based team. A China PEO will: DRAFT compliant employment contracts for your China team. HIRE AND ONBOARD employees on their China payroll. FILE all necessary paperwork for China employees. PROCESS PAYROLL and pay employees on schedule each month. TAKE CARE OF COMPLIANCE, HR or termination issues as they arise. A China PEO may be a company that operates only in China, or it may be an international PEO that hires employees in China and in other countries around the world. Horizons stands out as a China PEO through its: REGIONAL HQ IN SHANGHAI, meaning senior management are on the ground to deal with any issues. COST-EFFECTIVE SOLUTIONS. At $299 per employee, per month, no EOR in China is more affordable. WHOLLY-OWNED INFRASTRUCTURE. Horizons hires employees through its own entity and doesn’t subcontract. You deal only with Horizons. GLOBAL COVERAGE. With PEO solutions in 180+ locations around the world, Horizons as your China PEO means one global partner for all your hiring and payroll needs. SAVE MONEY AND TIME WITH A CHINA PEO What Are the Benefits of a China PEO? The benefits of using a China PEO service, rather than setting up your own subsidiary in China include: SAVING MONEY. Engaging a China PEO, rather than setting up a local subsidiary, will save you up to 85 percent of the cost of expanding into China. SPEED TO HIRE. With the Horizons China PEO solution, you can have your China team ready to go in as little as 12 hours. Where you set up your own subsidiary, it could take months. ENSURING FULL COMPLIANCE WITH CHINA LABOR LAWS. Labor law in China can be complex for new entrants into the market. A China PEO will ensure full labor law compliance with key requirements such as the Five Insurances and payroll taxes. SIMPLIFIED PAYROLL. When you use a PEO operating both in China and other locations, you only need to pay one invoice every month to cover it all. 360° HR AND RECRUITMENT. Horizons China PEO not only hires and pays your team in China, but also has in-house recruitment and can guide any international staff through the China work visa process. STEP-BY-STEP CHINA PEO How Does a China PEO Work? When you engage a China PEO, they will: HIRE YOUR CHINA EMPLOYEES. The China PEO becomes the legal employer of your employees in China, taking care of legal and HR responsibilities. This leaves you to focus on day-to-day company operations. MANAGE EMPLOYMENT CONTRACTS AND ONBOARDING. The PEO assists in drafting compliant China labor contracts, including terms on salary, benefits, working hours, and termination procedures. They also manage the onboarding process, ensuring that employees are legally registered and understand their employment terms. PROCESS PAYROLL AND HANDLE EMPLOYMENT TAXES. The China PEO takes care of payroll processing, ensuring accurate calculation of wages, social benefits, and taxes according to Chinese regulations. They also handle tax filings and ensure compliance with local tax laws, reducing the risk of penalties for non-compliance. ADMINISTER BENEFITS. The China PEO can provide employees with access to competitive benefits packages, including health insurance, pension schemes, and other perks. Since PEOs pool employees from multiple companies, they often can negotiate better rates for these benefits. TAKE CARE OF EXIT PROCEDURES. If an employment relationship needs to end, the PEO handles the termination process in accordance with Chinese labor law, including severance payments and the final settlement. To summarize, when your company engages a China PEO, your business is able to focus on strategic objectives and operational needs within the Chinese market, with the PEO taking care of HR functions and legal compliance. STAY COMPLIANT WITH CHINA LABOR LAWS Labor Laws One of the principal reasons for engaging a PEO in China (also known as a ‘China Employer of Record’ or ‘China EOR’), is to ensure full compliance with China’s employment laws. Here we explain in detail how a China PEO ensures: Compliance with China employment contract requirements Compliance with working hours, national holiday provisions, and China social security requirements. Employment contract types China requires all employers to provide a compliant employment contract that states the employee’s compensation, benefits, and termination requirements. Employment contracts in China should state the salary and additional compensation in the local Chinese Yuan Renminbi. When you partner with a China PEO & Employer of Record, a team of local experts can assist in drafting strong employment contracts compliant with local regulations. A PEO in China can provide your business with labor contracts in the three forms below. Project-based Probationary period	No probationary period. Termination	At completion of the project. Severance	Max. one months per year of employment. Fixed-term Probationary period Directly related to contract duration: 1-year contract: 1 month probation 2-year contract: 2 month probation 3+ year contract: 6 month probation Termination notice period 30 days (minimum and maximum allowed by labor law) Severance 2 months salary per year of service In cases of justified termination: 1 month’s salary per year of service In cases of dismissal on serious grounds: none Indefinite Probationary period Not available Termination notice period 30 days (minimum and maximum allowed by labor law) Severance 1 month salary per year of service Working hours in China China operates with a standard five-day working week that should not surpass 8 hours of work per day or 44 hours per week. Companies typically run on an 8am to 6pm schedule with a one-hour lunch break. There is a strict limit on overtime in China. Overtime is not allowed to exceed 36 hours per month, except where there is an emergency event requiring it. A China EOR ensures that all employment contracts reflect these statutory limits. Overtime must be compensated in the following way: For a regular workday: 150% of the standard hourly rate (also known as ‘time and a half’); For a rest day: 200% of the standard hourly rate, or a day off (also known as ‘double time, or a day in lieu’); For a statutory holiday: 300% of the standard hourly rate (also known as ‘triple time’). Hire compliantly in China without a local entity. Quick, compliant hiring in 12 hours—no subsidiary required. Get Started Chinese national holidays 2024 Holiday Schedule in China [2024] Paid time off The amount of paid time off employees are eligible to receive is based on how long they have been employed at their current company: Under 1 year of employment  | no leave entitlement 1-10 years of employment | 5 days of paid leave annually 10-20 years of employment | 10 days of paid leave annually 20+ years of employment | 15 days of paid leave annually Sick leave in China Employees are entitled to between 3 and 24 months paid leave to address medical ailments and treatment. The exact amount of time off will be based on how long the employee has been with the company. Sick pay should never drop below 80% of the local minimum wage. Workers compensation for injuries or illnesses incurred while working cover employees with legal entitlements of up to one year’s leave at full pay to receive medical treatment. Take a look at the chart below to learn more about the specifics of sick leave standards in China: Less than 6 months of sick leave (percentage of regular wages owed to the employee) Under 1 year of employment  —  no leave entitlement 1-10 years of employment — 5 days of paid leave annually 10-20 years of employment — 10 days of paid leave annually 20+ years of employment — 15 days of paid leave annually Over 6 months of sick leave Under 1 year of employment — 40% 1-3 years of employment — 50% 3+ years of employment — 60% In order for employees to receive the full wages due to them, workers must present a valid medical certificate from a certified doctor to their employer. Maternity leave in China China provides all female employees with 98 days of paid maternity leave. They can begin this leave within 15 days before child birth. Depending on the city, women over 24 are generally provided an additional 30 days for their “late maternity leave.” Women are traditionally granted full pay during their leave through social security or by their employers. China has laws in place that legally protect women from being terminated while pregnant or breastfeeding a newborn child. The laws for paternity leave differ greatly by location but typically do not exceed 14 days. Men in Shanghai usually receive three days of paternity leave, while men in Shenzhen generally are granted ten days. An EOR in China will ensure that all maternity leave obligations are fully complied with. Annual leave in China As well as standard Chinese compensation laws, many guaranteed benefits and supplemental options are available to employees. As China celebrates seven national holidays, the statutory minimum notes that employees be paid leave for each holiday. While this is the statutory minimum, several employers elect to provide employees with greater flexibility around holidays like the Chinese New Year. In addition to national holidays, annual vacation leave is another important employee benefit in China. Depending on how long an employee has been with an organization, there will be a set number of vacation days each year. In China, vacation days follow the following criteria: For employees that have been with a company less than a year, there are no mandatory vacation days. For employees that have been with a company between one and 10 years, there are five vacation days each year. Employees that have worked for a company between 10 and 20 years receive 10 days annual vacation. If an employee has been with an organization for at least 20 years, they are entitled to 15 days vacation each year. For foreign employers that are looking to hire either mid-level or senior executives, more vacation days are generally offered. In fact, it is common for such offers to come with up to four weeks of vacation time per year. Termination & severance in China In order to terminate an employee in China, there must be strong cause for dismissal and clearly documented grievances leading up to the termination. The initial employment contract must contain an agreed upon probationary period that can last up to six months in length. Specific time requirements for submitting a notice of termination vary widely by industry. Any employer terminating an employee of between one month and two year’s tenure must provide at least one week’s notice. Employees working for a company for over two years require notice of one week for each year of completed service up to 12 weeks of notice. Employers have the option of including “payment in lieu of notice” in employee contracts which permit employers to pay employees instead of providing them with a notice of termination. This is common in Chinese business practice. Navigating employee terminations and handling severance packages can be complicated for companies expanding overseas for the first time. Setting up a PEO in China can mitigate risk for foreign companies and provide guidance through this process. China's compulsory social security contributions Chinese employees are provided statutory benefits through the “five insurances” practice in China. These include health insurance, pension, worker’s compensation, maternity benefits, and unemployment insurance. However, additional benefits, such as housing, are predicated on the income tax bracket of the individual employee. These benefits are paid out of social contributions paid by both the employee and employer. More on this below. China social security for foreigners Different rules are applied to social security contributions from foreigners and Chinese nationals. Foreign employees in Shanghai are not yet required to pay the Chinese social security for foreign nationals. In other cities in China, foreigners must pay the full amount of Chinese social insurance. A PEO in China will ensure that all employees are paying the correct contributions. Individual income tax Effective January 1st, 2019, China has adjusted tax brackets and changed residency rules to reduce the tax burden on low-income earners, with new special additional deductions available for resident taxpayers. The Individual Income Tax is calculated on an annual basis. The China EOR will automatically withhold taxes in advance on a monthly basis on the accumulated income and deductions. Individuals may have additional taxes or tax returns to claim through the annual settlement process. Health insurance Standard health and pension insurance is provided through the national system, although supplementary health insurance can be provided to the employees. HASSLE-FREE CHINESE COMPENSATION & BENEFITS Compensation & Benefits China compensation laws The minimum wage in China varies greatly between provinces and cities. In Shenzhen, the minimum wage is 1,808 yuan per month. This is only slightly less than Shanghai, which has a monthly minimum wage of 1,820 yuan. However, in Guizhou, the monthly minimum drops significantly to 1,030 yuan. 13 month salary in China The 13th month salary is the standard type of bonus provided to employees working in China at the end of the year. Rewarding employees with the 13th month salary is extremely common in China. As such, we recommend being clear with the employee during the employment contract phase so the employee is aware of the bonus stipulations regarding their annual salary and bonus structure. Social security for Chinese nationals As mentioned above, Chinese employees are provided with statutory benefits through the “five insurances” practice in China. These include health insurance, pension, worker’s compensation, maternity benefits, and unemployment insurance. They are all funded through ‘social pooling’, formed from payments made by the state, employer and employee, to varying degrees. Entitlements are then acquired through contribution. However, additional benefits, such as housing, are predicated by the income tax bracket of the individual employee. China’s housing fund system allows Chinese employees to save money towards purchasing their own house, thus providing a way for local employees to have the means to ensure social security and stability in the country. The Housing Fund has no social pool, since the entire amount goes directly to employees’ personal Housing Fund accounts. An EOR in China will always ensure that social security obligations are fully complied with."
    text_chunks = get_text_chunks(document_text)
    vectorstore = get_vectorstore(text_chunks)
    conversation_chain = construct_conversation_chain(vectorstore)

    response = conversation_chain({'question': user_question})
    answer = response['chat_history'][-1].content

    return answer

@app.route('/upload', methods=['POST'])
def process():
    user_question  = request.json.get('question')
    answer = process_text_and_question(user_question)
    return jsonify({
        "answer": answer
    })
if __name__ == "__main__":
    app.run(debug='0.0.0.0', port=5000)
